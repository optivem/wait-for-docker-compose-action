name: 'Wait for Docker Compose Application'
description: 'Waits for a Docker Compose application to be ready by polling a health endpoint'
author: 'Optivem'
branding:
  icon: 'clock'
  color: 'blue'
inputs:
  url:
    description: 'The URL to check for application readiness (e.g., http://localhost:8080/)'
    required: true
    default: 'http://localhost:8080/'
  max-attempts:
    description: 'Maximum number of attempts before giving up'
    required: false
    default: '30'
  wait-seconds:
    description: 'Seconds to wait between attempts'
    required: false
    default: '10'
  working-directory:
    description: 'Working directory for docker compose commands'
    required: false
    default: '.'

runs:
  using: 'composite'
  steps:
    - name: Wait for Docker Compose Application to be Ready
      run: |
        echo "â³ Waiting for Docker Compose application to be ready at ${{ inputs.url }}..."
        max_attempts=${{ inputs.max-attempts }}
        wait_seconds=${{ inputs.wait-seconds }}
        attempt=1
        
        while [ $attempt -le $max_attempts ]; do
          if curl -f "${{ inputs.url }}" > /dev/null 2>&1; then
            echo "âœ… Docker Compose application is ready!"
            exit 0
          fi
          echo "ğŸ”„ Attempt $attempt/$max_attempts: Application not ready yet, waiting $wait_seconds seconds..."
          sleep $wait_seconds
          attempt=$((attempt + 1))
        done
        
        echo "âŒ Docker Compose application failed to become ready after $max_attempts attempts"
        echo "ğŸ” Checking Docker Compose container logs:"
        docker compose logs --timestamps --tail=50
        echo "ğŸ³ Docker Compose container status:"
        docker compose ps
        exit 1
      shell: bash
      working-directory: ${{ inputs.working-directory }}